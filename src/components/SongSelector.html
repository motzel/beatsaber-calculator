<div>
	<Select bind:selectedValue="selectedSong" items="{allSongs}" getOptionLabel="{getOptionLabel}" getSelectionLabel="{getOptionLabel}"
	 placeholder="Select a song..." optionIdentifier="id" on:clear="set({filters:{}, selectedSong: null})"></Select>

	{#if !selectedSong || selectedSong.level}
	<SongsFilters on:filter-songs="onFilterSongs(event)"></SongsFilters>
	{/if}

	{#if selectedSong && !selectedSong.level}
	<div class="custom-song">
		<label>Number of blocks in custom song</label>
		<input type="number" min="1" bind:value="customSongBlocks" />
	</div>
	{/if}
</div>

<style>
  label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.25rem;
  }

  .custom-song {
    margin-top: 0.5rem;
  }

  .custom-song input {
    color: #ddd;
    background-color: black;
    border-color: #3f4f5f;
  }
</style>

<script>
  import Select from "svelte-select";
  import SongsFilters from "./SongsFilters.html";

  export default {
    components: { Select, SongsFilters },

    data() {
      return {
        customSongBlocks: 300,

        filters: {},

        selectedSong: null,
        songs: [
          {
            title: "Custom song",
            artist: null,
            album: null
          },
          {
            title: "Pop Stars K/DA",
            artist: "League of legends",
            album: "Extras",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 226 },
              { mode: "Two-handed", level: "Normal", blocks: 341 },
              { mode: "Two-handed", level: "Hard", blocks: 486 },
              { mode: "Two-handed", level: "Expert", blocks: 679 },
              { mode: "Two-handed", level: "Expert+", blocks: 934 }
            ]
          },
          {
            title: "One hope",
            artist: "Knower",
            album: "Extras",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 286 },
              { mode: "Two-handed", level: "Normal", blocks: 376 },
              { mode: "Two-handed", level: "Hard", blocks: 503 },
              { mode: "Two-handed", level: "Expert", blocks: 731 },
              { mode: "Two-handed", level: "Expert+", blocks: 932 }
            ]
          },
          {
            title: "$100 bills",
            artist: "Jaroslav Beck",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 156 },
              { mode: "Two-handed", level: "Normal", blocks: 196 },
              { mode: "Two-handed", level: "Hard", blocks: 264 },
              { mode: "Two-handed", level: "Expert", blocks: 437 },
              { mode: "Two-handed", level: "Expert+", blocks: 734 }
            ]
          },
          {
            title: "Escape ft. Summer Haze",
            artist: "Jaroslav Beck, Summer Haze",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 157 },
              { mode: "Two-handed", level: "Normal", blocks: 295 },
              { mode: "Two-handed", level: "Hard", blocks: 287 },
              { mode: "Two-handed", level: "Expert", blocks: 399 },
              { mode: "Two-handed", level: "Expert+", blocks: 600 }
            ]
          },
          {
            title: "Legend ft. Backchat",
            artist: "Jaroslav Beck, Backchat, Generdyn",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 150 },
              { mode: "Two-handed", level: "Normal", blocks: 184 },
              { mode: "Two-handed", level: "Hard", blocks: 216 },
              { mode: "Two-handed", level: "Expert", blocks: 285 },
              { mode: "Two-handed", level: "Expert+", blocks: 638 }
            ]
          },
          {
            title: "Rum'n'bass",
            artist: "Boom kitty",
            album: "OST Vol. 2",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 155 },
              { mode: "Two-handed", level: "Normal", blocks: 285 },
              { mode: "Two-handed", level: "Hard", blocks: 401 },
              { mode: "Two-handed", level: "Expert", blocks: 603 },
              { mode: "Two-handed", level: "Expert+", blocks: 943 }
            ]
          },
          {
            title: "Unlimited power ft. Frank Bentley",
            artist: "Jaroslav Beck",
            album: "OST Vol. 2",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 124 },
              { mode: "Two-handed", level: "Normal", blocks: 199 },
              { mode: "Two-handed", level: "Hard", blocks: 302 },
              { mode: "Two-handed", level: "Expert", blocks: 380 },
              { mode: "Two-handed", level: "Expert+", blocks: 615 }
            ]
          },
          {
            title: "I need you",
            artist: "Megaphonix",
            album: "OST Vol. 2",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 145 },
              { mode: "Two-handed", level: "Normal", blocks: 224 },
              { mode: "Two-handed", level: "Hard", blocks: 338 },
              { mode: "Two-handed", level: "Expert", blocks: 423 },
              { mode: "Two-handed", level: "Expert+", blocks: 635 }
            ]
          },
          {
            title: "Be there for you ft. Kinnie Lane",
            artist: "Sedliv",
            album: "OST Vol. 2",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 146 },
              { mode: "Two-handed", level: "Normal", blocks: 250 },
              { mode: "Two-handed", level: "Hard", blocks: 323 },
              { mode: "Two-handed", level: "Expert", blocks: 519 },
              { mode: "Two-handed", level: "Expert+", blocks: 757 }
            ]
          },
          {
            title: "Beat Saber",
            artist: "Jaroslav Beck",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 94 },
              { mode: "Two-handed", level: "Normal", blocks: 116 },
              { mode: "Two-handed", level: "Hard", blocks: 202 },
              { mode: "Two-handed", level: "Expert", blocks: 267 },
              { mode: "Two-handed", level: "Expert+", blocks: 632 }
            ]
          },
          {
            title: "Angel Voices",
            artist: "Virtual Self",
            album: "Extras",
            levels: [
              { mode: "Two-handed", level: "Hard", blocks: 948 },
              { mode: "Two-handed", level: "Expert", blocks: 1202 },
              { mode: "Two-handed", level: "Expert+", blocks: 1681 }
            ]
          },
          {
            title: "Country roads Sqeepo remix",
            artist: "Jaroslav Beck, Kings&Folks",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 151 },
              { mode: "Two-handed", level: "Normal", blocks: 208 },
              { mode: "Two-handed", level: "Hard", blocks: 295 },
              { mode: "Two-handed", level: "Expert", blocks: 544 },
              { mode: "Two-handed", level: "Expert+", blocks: 773 }
            ]
          },
          {
            title: "Balearic pumping",
            artist: "Jaroslav Beck",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 170 },
              { mode: "Two-handed", level: "Normal", blocks: 239 },
              { mode: "Two-handed", level: "Hard", blocks: 341 },
              { mode: "Two-handed", level: "Expert", blocks: 459 },
              { mode: "Two-handed", level: "Expert+", blocks: 608 }
            ]
          },
          {
            title: "Breezer",
            artist: "Jaroslav Beck",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 106 },
              { mode: "Two-handed", level: "Normal", blocks: 173 },
              { mode: "Two-handed", level: "Hard", blocks: 272 },
              { mode: "Two-handed", level: "Expert", blocks: 356 },
              { mode: "Two-handed", level: "Expert+", blocks: 566 }
            ]
          },
          {
            title: "Commercial pumping",
            artist: "Jaroslav Beck",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 136 },
              { mode: "Two-handed", level: "Normal", blocks: 213 },
              { mode: "Two-handed", level: "Hard", blocks: 329 },
              { mode: "Two-handed", level: "Expert", blocks: 447 },
              { mode: "Two-handed", level: "Expert+", blocks: 848 }
            ]
          },
          {
            title: "Elixia",
            artist: "Mord fustang",
            album: "OST Vol. 2",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 143 },
              { mode: "Two-handed", level: "Normal", blocks: 300 },
              { mode: "Two-handed", level: "Hard", blocks: 375 },
              { mode: "Two-handed", level: "Expert", blocks: 494 },
              { mode: "Two-handed", level: "Expert+", blocks: 744 }
            ]
          },
          {
            title: "Turn me on ft. Tiny C",
            artist: "Jaroslav Beck, Tiny C",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 121 },
              { mode: "Two-handed", level: "Normal", blocks: 156 },
              { mode: "Two-handed", level: "Hard", blocks: 244 },
              { mode: "Two-handed", level: "Expert", blocks: 341 },
              { mode: "Two-handed", level: "Expert+", blocks: 663 }
            ]
          },
          {
            title: "Lvl insane",
            artist: "Jaroslav Beck",
            album: "OST Vol. 1",
            levels: [
              { mode: "Two-handed", level: "Easy", blocks: 102 },
              { mode: "Two-handed", level: "Normal", blocks: 139 },
              { mode: "Two-handed", level: "Hard", blocks: 198 },
              { mode: "Two-handed", level: "Expert", blocks: 330 },
              { mode: "Two-handed", level: "Expert+", blocks: 587 }
            ]
          }
        ],

        getOptionLabel: option =>
          (option.album ? option.album + " / " : "") +
          option.title +
          (option.level ? " / " + option.level : "")
      };
    },

    onstate({ changed, current, previous }) {
      if (changed.blocks) {
        this.fire("song-selected", {
          blocks: current.blocks,
          song: current.selectedSong,
          yourScore: current.filters.score ? current.filters.score : null
        });
      }

      if (changed.filters && current.allSongs.length === 1) {
        this.set({ selectedSong: current.allSongs[0] });

        this.fire("song-selected", {
          blocks: current.allSongs[0].blocks
            ? current.allSongs[0].blocks
            : current.customSongBlocks,
          song: current.allSongs[0],
          yourScore: current.filters.score ? current.filters.score : null
        });
      }
    },

    computed: {
      allSongs: ({ songs, filters }) => {
        let idx = 0;

        const isPropertyMatch = (value, filter) => {};
        const isSongMatchFilters = (item, filters) => {
          for (const filter in filters) {
            if (["score", "exactMatch"].includes(filter)) continue;

            if (
              filters[filter] &&
              (!item[filter] ||
                (!filters.exactMatch &&
                  !item[filter]
                    .toLowerCase()
                    .includes(filters[filter].toLowerCase())) ||
                (filters.exactMatch &&
                  item[filter].toLowerCase() !== filters[filter].toLowerCase()))
            )
              return false;
          }

          return true;
        };

        let allSongs = songs.reduce((cum, song) => {
          let levels = song.levels ? [].concat(song.levels) : null;
          let data = Object.assign({}, song);
          delete data.levels;

          return cum.concat(
            (levels
              ? levels.map(lvl => Object.assign({ id: idx++ }, data, lvl))
              : [Object.assign({ id: idx++ }, song)]
            ).filter(item => isSongMatchFilters(item, filters))
          );
        }, []);

        return allSongs;
      },

      blocks: ({ selectedSong, customSongBlocks }) => {
        if (!selectedSong) return 0;
        if (!selectedSong.level) return customSongBlocks;

        return selectedSong.blocks;
      }
    },

    methods: {
      onFilterSongs(filters) {
        this.set({ filters });
      }
    }
  };
</script>
